import requests,getpass
from bs4 import BeautifulSoup as bs
import sys


LOGIN_URL = "http://site24.way2sms.com/Login1.action"
CHECK_URL = "http://223.224.131.144/l8/Layer8Servlet"
SEND_SMS = "http://site24.way2sms.com/sendSMS?Token="
POST_SEND_MSG = "http://site24.way2sms.com/smstoss.action"
username = ""
password = ""
lastsent = ""

def Main():
	global username
	global password
	global lastsent
	sess = requests.Session()
	# sess.proxies.update({"http":"http://127.0.0.1:8080"})
	sess.headers.update({"User-Agent":"Opera/9.60 (J2ME/MIDP; Opera Mini/4.1.11320/608; U; en) Presto/2.2.0"})
	if username == "" or password == "":
		print "Authentication:"
		if username == "":
			username = raw_input("\tUsername/Mobile number: ")
		password = getpass.getpass("\tPassword(won't be echoed on screen): ")
	req = sess.post(LOGIN_URL,data={"username":username,"password":password})
	JSESSID =sess.cookies['JSESSIONID']
	token = JSESSID.split("~")[1]
	tokenpre = JSESSID.split("~")[0]
	sess.get(CHECK_URL,headers={"Referer":"http://site24.way2sms.com/ebrdg.action;jsessionid="+token+"?id="+token})
	if "welcome to Way2SMS" in req.content:
		print "[+] Good to go"
	print "Send Message:"
	number = raw_input("\tMobile Number("+lastsent+"): ")
	if number != "":
		lastsent = number
	else:
		number = lastsent
	message = raw_input("\tMessage: ")
	req = sess.get(SEND_SMS+token,headers={\
		"Referer":"http://site24.way2sms.com/main.action?section=s&Token="+token+"&vfType=register_verify",\
		"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",\
		"Accept-Language":" en-US,en;q=0.5",\
		"Accept-Encoding":" gzip, deflate"\
		})
	soup = bs(req.content)
	try:
		ssaction = soup.find("",{"name":"ssaction"})['value']
	except:
		ssaction = soup.find("",{"name":"ssaction"}).text
	sendsmsbody = {
					"ssaction":ssaction,\
					"mobile":number,\
					"message":message,\
					"msgLen":(140-len(message)),\
					"Token":token
				}
	print "[!] Sending \""+message+"\" to "+number+"\t"
	sendsmsheaders = {
		"Referer" : "http://site21.way2sms.com/sendSMS?Token="+token,\
		"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",\
		"Accept-Language": "en-US,en;q=0.5",\
		"Accept-Encoding": "gzip, deflate",\
	}
	req = sess.post(POST_SEND_MSG, data=sendsmsbody,headers=sendsmsheaders)
	if "Message has been submitted successfully." in req.content:
		print "[+] Sent successfully"

if __name__ == "__main__":
	if len(sys.argv)>1:
		username = sys.argv[1]
	try:
		while 1:
			Main()
	except KeyboardInterrupt:
		print "\n[-] Shutting down.."