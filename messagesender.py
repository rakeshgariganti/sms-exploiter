import requests,getpass
from bs4 import BeautifulSoup as bs
import sys


URL = "http://m1.way2sms.com/content/index.html"
LOGIN_URL = "http://m1.way2sms.com/Login1.action"
MAIN_VIEW = "http://m1.way2sms.com/MainView.action;jsessionid="
SEND_MSG = "http://m1.way2sms.com/singles.action?Token="
POST_SEND_MSG = "http://m1.way2sms.com/jsp/smstoss.action"
username = ""
password = ""
lastsent = ""

def Main():
	global username
	global password
	global lastsent
	sess = requests.Session()
	# sess.proxies.update({"http":"http://127.0.0.1:8080"})
	sess.headers.update({"User-Agent":"Opera/9.60 (J2ME/MIDP; Opera Mini/4.1.11320/608; U; en) Presto/2.2.0"})
	if username == "" or password == "":
		print "Authentication:"
		if username == "":
			username = raw_input("\tUsername/Mobile number: ")
		password = getpass.getpass("\tPassword(won't be echoed on screen): ")
	req = sess.post(LOGIN_URL,data={"gval":"","mobileB":"0.8828358977290672","scrWidth":"1321","username":username,"password":password})
	JSESSID =sess.cookies['JSESSIONID']
	token = JSESSID.split("~")[1]
	tokenpre = JSESSID.split("~")[0]
	if "welcome to the all new Way2SMS" in req.content:
		print "[+] Good to go"
	print "Send Message:"
	number = raw_input("\tMobile Number("+lastsent+"): ")
	if number != "":
		lastsent = number
	else:
		number = lastsent
	message = raw_input("\tMessage: ")
	req = sess.get(SEND_MSG+token,headers={\
		"Referer":"http://m1.way2sms.com/Main.action?h=&id="+token+"&data=SMS",\
		"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",\
		"Accept-Language":" en-US,en;q=0.5",\
		"Accept-Encoding":" gzip, deflate"\
		})
	soup = bs(req.content)
	mobnoid = soup.find("",{"placeholder":"Mobile Number","maxlength":"10"})['id']
	s = soup.findAll("script")
	script = ""
	for i in s:
		if token in i.text:
			script = i.text
			break
	d = list()
	for i in script.split("\n"):
		if "setAttribute(\"value\"" in i:
			d.append(i.split("\"")[3])
		if "setAttribute(\"name\"" in i:
			d.append(i.split("\"")[3])
	try:
		smsActTo = soup.find("",{"name":"smsActTo"})['value']
	except:
		smsActTo = soup.find("",{"name":"smsActTo"}).text
	try:
		catnamedis = soup.find("",{"name":"catnamedis"})['value']
	except:
		catnamedis = soup.find("",{"name":"catnamedis"}).text
	try:
		t_15_k_5 = soup.find("",{"name":"t_15_k_5"})['value']
	except:
		t_15_k_5 = soup.find("",{"name":"t_15_k_5"}).text
	try:
		a_m_p = soup.find("",{"name":"a_m_p"})['value']
	except :
		a_m_p = soup.find("",{"name":"a_m_p"}).text
	try:
		w2sms = soup.find("",{"name":"w2sms"})['value']
	except:
		w2sms = soup.find("",{"name":"w2sms"}).text
	try:
		pjkdws = soup.find("",{"name":"pjkdws"})['value']
	except:
		pjkdws = soup.find("",{"name":"pjkdws"}).text
	try:
		m_15_b = soup.find("",{"name":"m_15_b"})['value']
	except:
		m_15_b = soup.find("",{"name":"m_15_b"}).text
	try:
		adno = soup.find("",{"name":"adno"})['value']
	except:
		adno = soup.find("",{"name":"adno"}).text
	sendsmsbody = {"smsActTo":smsActTo,\
					"catnamedis": catnamedis,\
					"t_15_k_5" : t_15_k_5,\
					"a_m_p" : a_m_p,\
					"w2sms" : w2sms,\
					"pjkdws" : pjkdws,\
					"m_15_b" : m_15_b,\
					"adno" : adno,\
					"Token" : token,\
					"textfield2" : "+91",\
					mobnoid : number,\
					"textArea" : message,\
					"txtLen" : (140-len(message)),\
					d[1] : d[0],\
					d[3] : token
				}
	print "[!] Sending \""+message+"\" to "+number+"\t"
	sendsmsheaders = {
		"Referer" : "http://m1.way2sms.com/jsp/SingleSMS.jsp?Token="+token,\
		"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",\
		"Accept-Language": "en-US,en;q=0.5",\
		"Accept-Encoding": "gzip, deflate",\
	}
	req = sess.post(POST_SEND_MSG, data=sendsmsbody,headers=sendsmsheaders)
	if req.status_code:
		print "[+] Message Sent."

if __name__ == "__main__":
	if len(sys.argv)>1:
		username = sys.argv[1]
	try:
		while 1:
			Main()
	except KeyboardInterrupt:
		print "\n[-] Shutting down.."